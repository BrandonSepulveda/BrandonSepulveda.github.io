<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Informes Proactivo v2.0</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons Library (Lucide) -->
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.min.js"></script>
    <!-- PDF Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --primary: #0066cc;
            --secondary: #f0f4f8;
            --accent: #e63946;
            --text-main: #1f2937;
            --text-light: #6b7280;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .preview-container h1 { font-size: 1.75rem; font-weight: bold; color: var(--text-main); margin-bottom: 0.25rem; }
        .preview-container h2 { font-size: 1.25rem; font-weight: 600; color: var(--primary); margin-bottom: 1rem; border-left: 4px solid var(--primary); padding-left: 0.75rem; }
        .preview-container table th { background-color: var(--primary); color: white; }
        .preview-container .alert-tag { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 500; margin-right: 0.25rem; margin-bottom: 0.25rem; }
        .preview-container .alert-alta { background-color: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; }
        .preview-container .alert-media { background-color: #fff8e1; color: #ff8f00; border: 1px solid #ffe082; }
        .preview-container .alert-baja { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #aaa; }

        /* Add a subtle animation for dynamically added items */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Acceso Protegido</h2>
            <p class="text-gray-500 mb-6">Ingresa tus credenciales para continuar.</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="sr-only">Usuario</label>
                    <input type="text" id="username-input" placeholder="Usuario" class="w-full text-center px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="password" class="sr-only">Contraseña</label>
                    <input type="password" id="password-input" placeholder="Contraseña" class="w-full text-center px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <p id="error-message" class="text-red-500 text-sm mb-4 hidden">Usuario o contraseña incorrectos.</p>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="log-in" class="w-5 h-5"></i>
                    <span>Ingresar</span>
                </button>
            </form>
        </div>
    </div>

    <div id="app" class="flex flex-col h-screen hidden">
        <!-- Header -->
        <header class="bg-white shadow-md w-full p-4 flex justify-between items-center z-10">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg text-white">
                    <i data-lucide="file-text"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-800">Editor de Informes Proactivo v2.0</h1>
            </div>
            <div class="flex items-center gap-2">
                <input type="file" id="load-json-input" class="hidden" accept=".json">
                <button id="load-json-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                    <i data-lucide="upload" class="w-4 h-4"></i> Cargar Datos (.json)
                </button>
                <button id="save-json-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                    <i data-lucide="save" class="w-4 h-4"></i> Guardar Datos (.json)
                </button>
                <button id="export-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                    <i data-lucide="file-down" class="w-4 h-4"></i> Exportar a PDF
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 p-4 overflow-hidden">
            <!-- Editor Panel -->
            <div id="editor-panel" class="bg-white rounded-lg shadow-lg p-6 overflow-y-auto custom-scrollbar">
                <h2 class="text-2xl font-bold mb-6 text-blue-600 border-b pb-2">Editor de Contenido</h2>
                
                <!-- Sections will be injected here by JavaScript -->
            </div>

            <!-- Preview Panel -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col">
                <div class="p-6 border-b">
                    <h2 class="text-2xl font-bold text-blue-600">Vista Previa en Tiempo Real</h2>
                </div>
                <div id="preview-panel" class="p-8 overflow-y-auto custom-scrollbar flex-grow">
                    <!-- Preview content will be injected here -->
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- INITIAL DATA & STATE ---
        let reportData = {
            empresa: "Milenio PC",
            fecha: "Octubre 2025",
            titulo: "Detección Exitosa de Riesgos en Incidentes Potenciales",
            analista: "Laura Marcela Osorio",
            resumen: "Durante el mes, se generaron un total de 4 casos de alertas en el monitoreo de Tech Pulse. A continuación se presenta un análisis detallado de los casos registrados, las intervenciones realizadas y las recomendaciones para el próximo periodo.",
            estadoIntervencion: "Los casos no fueron intervenidos por disponibilidad del usuario.",
            notaImportante: "Quedamos atentos a su disponibilidad para atender estas alertas como parte de nuestra gestión proactiva. La pronta intervención de estos casos podría prevenir incidentes mayores en la operación.",
            yearFooter: new Date().getFullYear(),
            fechaGeneracion: new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' }),
            insights: [
                { id: 1, numero: 41, etiqueta: "Alertas detectadas", porcentaje: false },
                { id: 2, numero: 4, etiqueta: "Casos registrados", porcentaje: false },
                { id: 3, numero: 0, etiqueta: "Casos intervenidos", porcentaje: false },
                { id: 4, numero: 100, etiqueta: "Pendientes de intervención", porcentaje: true }
            ],
            categorias: [
                { id: 1, categoria: "Batería", cantidad: 36, caso: 107662, prioridad: "alta", observacion: "Se detectaron 36 alertas reportadas para verificaciones del estado real de las baterías." },
                { id: 2, categoria: "BIOS", cantidad: 2, caso: 107660, prioridad: "media", observacion: "Casos vinculados a versiones desactualizadas. Se envió listado con los equipos para intervenir." },
                { id: 3, categoria: "Pantallazos azules", cantidad: 1, caso: 107659, prioridad: "alta", observacion: "Alertas relacionadas a equipos con pantallazos azules críticos con más de 3 registros de recurrencia en el mes." },
                { id: 4, categoria: "Almacenamiento", cantidad: 2, caso: 107659, prioridad: "media", observacion: "Equipos con alertas de poco espacio de disco." }
            ],
            recomendaciones: [
                { id: 1, texto: "Programar intervenciones para las 36 alertas de batería a la mayor brevedad posible." },
                { id: 2, texto: "Actualizar las versiones de BIOS de forma remota durante horarios no laborables." },
                { id: 3, texto: "Realizar análisis detallado de los pantallazos azules recurrentes para identificar patrones." },
                { id: 4, texto: "Proponer una campaña de limpieza de almacenamiento para los equipos con poco espacio." }
            ]
        };

        // --- DOM ELEMENTS ---
        const editorPanel = document.getElementById('editor-panel');
        const previewPanel = document.getElementById('preview-panel');

        // --- UTILITY FUNCTIONS ---
        const createId = () => Date.now();

        // --- RENDER FUNCTIONS ---
        
        // Helper to create form groups
        const createFormGroup = (label, input) => {
            const group = document.createElement('div');
            group.className = 'mb-4';
            const labelEl = document.createElement('label');
            labelEl.className = 'block text-sm font-medium text-gray-600 mb-1';
            labelEl.textContent = label;
            group.appendChild(labelEl);
            group.appendChild(input);
            return group;
        };
        
        const createTextInput = (id, placeholder, value) => {
            const input = document.createElement('input');
            input.type = 'text';
            input.id = id;
            input.placeholder = placeholder;
            input.value = value;
            input.className = 'w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500';
            input.dataset.key = id;
            return input;
        };
        
        const createTextArea = (id, placeholder, value) => {
            const textarea = document.createElement('textarea');
            textarea.id = id;
            textarea.placeholder = placeholder;
            textarea.value = value;
            textarea.className = 'w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 min-h-[80px]';
            textarea.dataset.key = id;
            return textarea;
        };

        const createSectionHeader = (title) => {
            const h3 = document.createElement('h3');
            h3.className = 'text-lg font-semibold mt-6 mb-3 text-gray-700 border-t pt-4';
            h3.textContent = title;
            return h3;
        };

        const createAddButton = (text, id) => {
            const button = document.createElement('button');
            button.id = id;
            button.className = 'mt-2 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors text-sm';
            button.innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4"></i> ${text}`;
            return button;
        };

        function renderEditor() {
            editorPanel.innerHTML = ''; // Clear previous content

            // General Info
            editorPanel.appendChild(createSectionHeader('Información General'));
            editorPanel.appendChild(createFormGroup('Empresa', createTextInput('empresa', 'Nombre de la empresa', reportData.empresa)));
            editorPanel.appendChild(createFormGroup('Fecha Informe', createTextInput('fecha', 'Ej. Octubre 2025', reportData.fecha)));
            editorPanel.appendChild(createFormGroup('Título del Informe', createTextInput('titulo', 'Título principal', reportData.titulo)));
            editorPanel.appendChild(createFormGroup('Analista', createTextInput('analista', 'Nombre del analista', reportData.analista)));

            // Summary
            editorPanel.appendChild(createSectionHeader('Resumen Ejecutivo'));
            editorPanel.appendChild(createFormGroup('Texto de resumen', createTextArea('resumen', 'Escribe el resumen...', reportData.resumen)));

            // Insights
            editorPanel.appendChild(createSectionHeader('Cuadro de Estadísticas'));
            const insightsContainer = document.createElement('div');
            insightsContainer.id = 'insights-container';
            reportData.insights.forEach(item => insightsContainer.appendChild(createInsightEditor(item)));
            editorPanel.appendChild(insightsContainer);
            editorPanel.appendChild(createAddButton('Añadir Estadística', 'add-insight-btn'));

            // Categories
            editorPanel.appendChild(createSectionHeader('Categorías Detectadas'));
            const categoriesContainer = document.createElement('div');
            categoriesContainer.id = 'categorias-container';
            reportData.categorias.forEach(item => categoriesContainer.appendChild(createCategoryEditor(item)));
            editorPanel.appendChild(categoriesContainer);
            editorPanel.appendChild(createAddButton('Añadir Categoría', 'add-categoria-btn'));

            // Intervention
            editorPanel.appendChild(createSectionHeader('Estado de Intervención'));
            editorPanel.appendChild(createFormGroup('Estado', createTextArea('estadoIntervencion', 'Describe el estado...', reportData.estadoIntervencion)));
            editorPanel.appendChild(createFormGroup('Nota Importante', createTextArea('notaImportante', 'Añade una nota...', reportData.notaImportante)));
            
            // Recommendations
            editorPanel.appendChild(createSectionHeader('Recomendaciones'));
            const recomendacionesContainer = document.createElement('div');
            recomendacionesContainer.id = 'recomendaciones-container';
            reportData.recomendaciones.forEach(item => recomendacionesContainer.appendChild(createRecomendacionEditor(item)));
            editorPanel.appendChild(recomendacionesContainer);
            editorPanel.appendChild(createAddButton('Añadir Recomendación', 'add-recomendacion-btn'));

            // Footer
            editorPanel.appendChild(createSectionHeader('Pie de Página'));
            editorPanel.appendChild(createFormGroup('Año', createTextInput('yearFooter', 'Año para el footer', reportData.yearFooter)));
            editorPanel.appendChild(createFormGroup('Fecha de Generación', createTextInput('fechaGeneracion', 'Fecha completa', reportData.fechaGeneracion)));
            
            lucide.createIcons();
        }
        
        function createInsightEditor(insight) {
            const item = document.createElement('div');
            item.className = 'p-3 border rounded-lg mb-3 grid grid-cols-12 gap-2 items-end bg-slate-50 fade-in';
            item.dataset.id = insight.id;
            
            item.innerHTML = `
                <div class="col-span-3">
                    <label class="text-xs font-medium text-gray-500">Número</label>
                    <input type="number" data-key="numero" value="${insight.numero}" class="w-full text-sm mt-1 px-2 py-1 border border-gray-300 rounded-md">
                </div>
                <div class="col-span-5">
                    <label class="text-xs font-medium text-gray-500">Etiqueta</label>
                    <input type="text" data-key="etiqueta" value="${insight.etiqueta}" class="w-full text-sm mt-1 px-2 py-1 border border-gray-300 rounded-md">
                </div>
                <div class="col-span-3 flex items-center justify-center">
                    <input type="checkbox" data-key="porcentaje" ${insight.porcentaje ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label class="ml-2 text-xs font-medium text-gray-500">Es %</label>
                </div>
                <div class="col-span-1">
                    <button class="delete-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            `;
            return item;
        }

        function createCategoryEditor(category) {
            const item = document.createElement('div');
            item.className = 'p-4 border rounded-lg mb-3 bg-slate-50 fade-in';
            item.dataset.id = category.id;
            item.innerHTML = `
                <div class="grid grid-cols-3 gap-2 mb-2">
                     <div>
                        <label class="text-xs font-medium text-gray-500">Categoría</label>
                        <input type="text" data-key="categoria" value="${category.categoria}" class="w-full text-sm mt-1 px-2 py-1 border border-gray-300 rounded-md">
                    </div>
                     <div>
                        <label class="text-xs font-medium text-gray-500">Cantidad</label>
                        <input type="number" data-key="cantidad" value="${category.cantidad}" class="w-full text-sm mt-1 px-2 py-1 border border-gray-300 rounded-md">
                    </div>
                     <div>
                        <label class="text-xs font-medium text-gray-500">Caso #</label>
                        <input type="number" data-key="caso" value="${category.caso}" class="w-full text-sm mt-1 px-2 py-1 border border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="mb-2">
                    <label class="text-xs font-medium text-gray-500">Prioridad</label>
                    <select data-key="prioridad" class="w-full text-sm mt-1 px-2 py-1 border border-gray-300 rounded-md">
                        <option value="alta" ${category.prioridad === 'alta' ? 'selected' : ''}>Alta</option>
                        <option value="media" ${category.prioridad === 'media' ? 'selected' : ''}>Media</option>
                        <option value="baja" ${category.prioridad === 'baja' ? 'selected' : ''}>Baja</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label class="text-xs font-medium text-gray-500">Observación</label>
                    <textarea data-key="observacion" class="w-full text-sm mt-1 px-2 py-1 border border-gray-300 rounded-md min-h-[60px]">${category.observacion}</textarea>
                </div>
                <button class="delete-btn text-red-500 hover:text-red-700 text-sm flex items-center gap-1"><i data-lucide="trash-2" class="w-4 h-4"></i> Eliminar Categoría</button>
            `;
            return item;
        }

        function createRecomendacionEditor(recomendacion) {
            const item = document.createElement('div');
            item.className = 'p-3 border rounded-lg mb-3 flex items-center gap-2 bg-slate-50 fade-in';
            item.dataset.id = recomendacion.id;
            item.innerHTML = `
                <textarea data-key="texto" class="flex-grow w-full text-sm px-2 py-1 border border-gray-300 rounded-md">${recomendacion.texto}</textarea>
                <button class="delete-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
            `;
            return item;
        }


        function renderPreview() {
            const { empresa, fecha, titulo, analista, resumen, insights, categorias, estadoIntervencion, notaImportante, recomendaciones, yearFooter, fechaGeneracion } = reportData;
            
            const prioridadMap = {
                alta: { label: 'Alta Prioridad', class: 'alert-alta' },
                media: { label: 'Media Prioridad', class: 'alert-media' },
                baja: { label: 'Baja Prioridad', class: 'alert-baja' },
            };

            previewPanel.innerHTML = `
                <div class="preview-container">
                    <header class="flex justify-between items-center mb-8 pb-4 border-b-2 border-blue-600">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center text-white font-bold text-2xl">
                                ${empresa.charAt(0)}
                            </div>
                            <h3 class="text-2xl font-semibold">${empresa}</h3>
                        </div>
                        <p class="text-gray-500">Informe Mensual: ${fecha}</p>
                    </header>

                    <section class="mb-8">
                        <h1>${titulo}</h1>
                        <div class="mt-2 inline-block bg-blue-600 text-white text-sm font-semibold px-4 py-2 rounded-md">Analista: ${analista}</div>
                    </section>

                    <section class="bg-slate-100 p-6 rounded-lg mb-8 border-l-4 border-blue-600">
                        <h2>Resumen Ejecutivo</h2>
                        <p class="text-gray-600">${resumen.replace(/\n/g, '<br>')}</p>
                    </section>

                    <section class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                        ${insights.map(i => `
                            <div class="bg-white p-5 rounded-lg shadow-md border-t-4 border-blue-600 text-center transition-transform hover:scale-105">
                                <div class="text-4xl font-bold text-blue-600">${i.numero}${i.porcentaje ? '%' : ''}</div>
                                <div class="text-sm text-gray-500 mt-2">${i.etiqueta}</div>
                            </div>
                        `).join('')}
                    </section>

                    <section class="mb-8">
                        <h2>Aclaración por Categoría Detectada</h2>
                        <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500 mt-4">
                            <thead class="text-xs text-white uppercase">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Categoría</th>
                                    <th scope="col" class="px-6 py-3">Cantidad</th>
                                    <th scope="col" class="px-6 py-3">Caso</th>
                                    <th scope="col" class="px-6 py-3">Observación</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${categorias.map((cat, index) => `
                                <tr class="bg-white border-b ${index % 2 !== 0 ? 'bg-slate-50' : ''}">
                                    <td class="px-6 py-4 font-medium text-gray-900">${cat.categoria}</td>
                                    <td class="px-6 py-4">${cat.cantidad}</td>
                                    <td class="px-6 py-4">${cat.caso}</td>
                                    <td class="px-6 py-4">
                                        <span class="alert-tag ${prioridadMap[cat.prioridad]?.class || ''}">${prioridadMap[cat.prioridad]?.label || 'Sin Prioridad'}</span>
                                        <p class="mt-1">${cat.observacion}</p>
                                    </td>
                                </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        </div>
                    </section>
                    
                     <section class="mb-8 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-6 rounded-lg">
                        <h2>Estado de Intervención</h2>
                        <p>${estadoIntervencion}</p>
                        <div class="mt-4 bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4">
                            <strong>Nota importante:</strong> ${notaImportante}
                        </div>
                    </section>
                    
                    <section class="mb-8 bg-slate-100 p-6 rounded-lg">
                        <h2>Recomendaciones</h2>
                        <ul class="list-disc list-inside text-gray-600 space-y-2">
                            ${recomendaciones.map(r => `<li>${r.texto}</li>`).join('')}
                        </ul>
                    </section>

                    <footer class="mt-10 pt-6 border-t text-center text-xs text-gray-500">
                        <p>© MILENIO PC ${yearFooter} ${empresa} | HP Workforce Experience Platform | Reporte generado el ${fechaGeneracion}</p>
                    </footer>
                </div>
            `;
        }

        // --- EVENT HANDLERS & LOGIC ---
        function handleEditorUpdate(e) {
            const target = e.target;
            const key = target.dataset.key;
            
            if (!key) return;

            // Handle simple fields
            if (reportData.hasOwnProperty(key)) {
                reportData[key] = target.value;
                renderPreview();
                return;
            }

            // Handle dynamic lists
            const parent = target.closest('[data-id]');
            if (!parent) return;

            const id = Number(parent.dataset.id);
            const container = parent.parentElement;
            
            let dataArray;
            if (container.id === 'insights-container') dataArray = reportData.insights;
            else if (container.id === 'categorias-container') dataArray = reportData.categorias;
            else if (container.id === 'recomendaciones-container') dataArray = reportData.recomendaciones;
            
            if (dataArray) {
                const item = dataArray.find(i => i.id === id);
                if (item) {
                    if (target.type === 'checkbox') {
                        item[key] = target.checked;
                    } else if (target.type === 'number') {
                        item[key] = Number(target.value);
                    } else {
                        item[key] = target.value;
                    }
                    renderPreview();
                }
            }
        }
        
        function handleAddItem(type) {
             const newItemContainer = document.getElementById(`${type}-container`);
             let newItem;
             let newItemEditor;

             if(type === 'insights') {
                const newId = createId();
                newItem = { id: newId, numero: 0, etiqueta: "Nueva estadística", porcentaje: false };
                reportData.insights.push(newItem);
                newItemEditor = createInsightEditor(newItem);
             } else if (type === 'categorias') {
                const newId = createId();
                newItem = { id: newId, categoria: "Nueva", cantidad: 0, caso: 0, prioridad: "media", observacion: "" };
                reportData.categorias.push(newItem);
                newItemEditor = createCategoryEditor(newItem);
             } else if (type === 'recomendaciones') {
                 const newId = createId();
                 newItem = { id: newId, texto: "Nueva recomendación." };
                 reportData.recomendaciones.push(newItem);
                 newItemEditor = createRecomendacionEditor(newItem);
             }
             
             if (newItemContainer && newItemEditor) {
                newItemContainer.appendChild(newItemEditor);
                lucide.createIcons();
                renderPreview();
             }
        }
        
        function handleDeleteItem(e) {
            if (!e.target.closest('.delete-btn')) return;
            
            const itemElement = e.target.closest('[data-id]');
            if (!itemElement) return;

            const id = Number(itemElement.dataset.id);
            const containerId = itemElement.parentElement.id;
            
            if (containerId === 'insights-container') {
                reportData.insights = reportData.insights.filter(i => i.id !== id);
            } else if (containerId === 'categorias-container') {
                reportData.categorias = reportData.categorias.filter(c => c.id !== id);
            } else if (containerId === 'recomendaciones-container') {
                reportData.recomendaciones = reportData.recomendaciones.filter(r => r.id !== id);
            }
            
            itemElement.remove();
            renderPreview();
        }

        function saveDataToJson() {
            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte-datos-${reportData.empresa.replace(/ /g, '_')}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function loadDataFromJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    // Basic validation
                    if(json.empresa && json.insights && json.categorias) {
                        reportData = json;
                        renderAll();
                    } else {
                        alert('El archivo JSON no parece tener el formato correcto.');
                    }
                } catch (err) {
                    alert('Error al leer el archivo JSON. Asegúrate de que el formato es válido.');
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        function exportToPdf() {
            const element = document.getElementById('preview-panel');
            const opt = {
              margin:       0.5,
              filename:     `informe_${reportData.empresa.replace(/ /g, '_')}_${reportData.fecha}.pdf`,
              image:        { type: 'jpeg', quality: 0.98 },
              html2canvas:  { scale: 2, letterRendering: true, useCORS: true },
              jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }
        
        // --- INITIALIZATION ---
        function renderAll() {
            renderEditor();
            renderPreview();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- LOGIN LOGIC ---
            const correctUserHash = "YWRtaW4="; // "admin" in Base64
            const correctPasswordHash = "UGFzc3cwcmQ="; // "Passw0rd" in Base64
            const loginOverlay = document.getElementById('login-overlay');
            const loginForm = document.getElementById('login-form');
            const usernameInput = document.getElementById('username-input');
            const passwordInput = document.getElementById('password-input');
            const errorMessage = document.getElementById('error-message');
            const appContainer = document.getElementById('app');
            
            lucide.createIcons(); // Create login icon

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                // Decode from Base64 and compare
                try {
                    if (usernameInput.value === atob(correctUserHash) && passwordInput.value === atob(correctPasswordHash)) {
                        loginOverlay.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        // Initialize the app after successful login
                        initializeApp();
                    } else {
                        errorMessage.classList.remove('hidden');
                        passwordInput.value = '';
                        usernameInput.focus();
                    }
                } catch (err) {
                    console.error("Error decoding credentials:", err);
                    errorMessage.classList.remove('hidden');
                }
            });

            function initializeApp() {
                renderAll();
                
                // Event Listeners
                editorPanel.addEventListener('input', handleEditorUpdate);
                editorPanel.addEventListener('click', handleDeleteItem);
                
                document.getElementById('add-insight-btn').addEventListener('click', () => handleAddItem('insights'));
                document.getElementById('add-categoria-btn').addEventListener('click', () => handleAddItem('categorias'));
                document.getElementById('add-recomendacion-btn').addEventListener('click', () => handleAddItem('recomendaciones'));

                document.getElementById('save-json-btn').addEventListener('click', saveDataToJson);
                document.getElementById('load-json-btn').addEventListener('click', () => document.getElementById('load-json-input').click());
                document.getElementById('load-json-input').addEventListener('change', loadDataFromJson);
                document.getElementById('export-pdf-btn').addEventListener('click', exportToPdf);

                lucide.createIcons(); // Re-run for icons inside the app
            }
        });
    </script>
</body>
</html>

