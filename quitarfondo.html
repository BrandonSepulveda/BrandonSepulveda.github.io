<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Removedor de Fondos Pro | Brandon Sepulveda</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/BrandonSepulveda/ToolboxBS/refs/heads/main/images/Logo-30.ico" />
    
    <!-- Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9012803289038112" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2RY7LG5R21"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-2RY7LG5R21');
    </script>
    
    <!-- Librerías Externas -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Paleta de Colores Refinada */
            --bg-dark: #050505;
            --bg-glass: rgba(20, 20, 20, 0.6);
            --bg-glass-border: rgba(255, 255, 255, 0.08);
            --kick-color: #53FC18;
            --kick-glow: rgba(83, 252, 24, 0.4);
            --text-main: #ffffff;
            --text-muted: #cccccc; /* Mucho más claro para mejor lectura */
        }

        /* --- Base & Background Animado --- */
        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(83, 252, 24, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(255, 255, 255, 0.03) 0%, transparent 25%);
        }

        /* CORRECCIÓN DE VISIBILIDAD DE TEXTO */
        h1, h2, h3, h4, h5, h6 { color: #ffffff !important; }
        p, span, div { color: inherit; }
        
        /* Forzamos que la clase text-muted sea visible en fondo negro */
        .text-muted {
            color: var(--text-muted) !important;
        }

        /* Scrollbar Personalizado */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--kick-color); }

        /* --- Navbar Glassmorphism --- */
        #mainNav {
            padding: 1.5rem 0;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            z-index: 1000;
        }
        #mainNav.navbar-scrolled {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0.8rem 0;
            border-bottom: 1px solid var(--bg-glass-border);
        }
        
        /* CORRECCIÓN LOGO Y LINKS */
        .navbar-brand { 
            font-weight: 800; 
            font-size: 1.4rem; 
            letter-spacing: -0.5px;
            color: #ffffff !important; /* Forzado a blanco */
        }
        
        .nav-link { 
            color: #bbbbbb !important; /* Gris claro por defecto */
            font-weight: 500; 
            transition: 0.3s; 
            position: relative;
        }
        .nav-link:hover, .nav-link.active { color: #ffffff !important; }
        .nav-link.active::after {
            content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 5px; height: 5px; background: var(--kick-color); border-radius: 50%; box-shadow: 0 0 10px var(--kick-color);
        }

        /* --- Cards & Containers (Glass Effect) --- */
        .glass-panel {
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--bg-glass-border);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        /* --- Upload Area --- */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255,255,255,0.02);
            position: relative;
            overflow: hidden;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--kick-color);
            background: rgba(83, 252, 24, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 10px 40px -10px rgba(83, 252, 24, 0.1);
        }
        .upload-icon-wrapper {
            width: 70px; height: 70px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 1.5rem;
            color: var(--kick-color);
            font-size: 1.8rem;
            transition: 0.3s;
        }
        .upload-area:hover .upload-icon-wrapper { transform: scale(1.1) rotate(5deg); background: var(--kick-color); color: #000; }

        /* --- Controles --- */
        .control-group {
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 1.25rem;
            border: 1px solid rgba(255,255,255,0.05);
            margin-bottom: 1rem;
        }
        .control-label {
            font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;
            color: #b0b0b0; /* Texto de etiquetas más claro */
            font-weight: 700; margin-bottom: 0.8rem; display: block;
        }
        
        /* Color Input Custom */
        .color-input-wrapper { display: flex; gap: 10px; align-items: center; }
        input[type="color"] {
            -webkit-appearance: none; border: none; width: 50px; height: 50px; padding: 0; background: none; cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; }

        /* Slider Custom */
        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 22px; height: 22px; background: var(--kick-color);
            border-radius: 50%; cursor: pointer; box-shadow: 0 0 15px var(--kick-glow); transition: 0.2s;
            border: 3px solid #000;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* --- Canvas & Preview --- */
        .canvas-wrapper {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            background: #000;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        canvas {
            display: block; width: 100%; height: auto;
            background-image: 
                linear-gradient(45deg, #1a1a1a 25%, transparent 25%), 
                linear-gradient(-45deg, #1a1a1a 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #1a1a1a 75%),
                linear-gradient(-45deg, transparent 75%, #1a1a1a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #111;
        }

        /* --- Botones --- */
        .btn-kick {
            background: var(--kick-color);
            color: #000;
            font-weight: 800;
            padding: 1rem 2rem;
            border-radius: 12px;
            border: none;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 25px rgba(83, 252, 24, 0.2);
        }
        .btn-kick:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 35px rgba(83, 252, 24, 0.4);
            background: #60ff26;
            color: #000;
        }
        .btn-secondary-custom {
            background: rgba(255,255,255,0.05);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 0.6rem 1rem;
            font-weight: 600;
            transition: 0.3s;
        }
        .btn-secondary-custom:hover, .btn-secondary-custom.active {
            background: #fff;
            color: #000;
            border-color: #fff;
        }
        .btn-secondary-custom.active-mode {
            background: #ff4757;
            border-color: #ff4757;
            color: white;
            animation: pulse 1.5s infinite;
        }

        /* --- Loading & Utilities --- */
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 10;
            opacity: 0; pointer-events: none; transition: 0.3s;
            border-radius: 16px;
        }
        .loading-overlay.active { opacity: 1; pointer-events: all; }
        
        .spinner-custom {
            width: 50px; height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: var(--kick-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); } }

        .compare-btn {
            position: absolute;
            bottom: 15px; right: 15px;
            background: rgba(0,0,0,0.8);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 0.8rem;
            pointer-events: auto;
            cursor: pointer;
            backdrop-filter: blur(4px);
            z-index: 5;
            transition: 0.2s;
        }
        .compare-btn:hover { background: #fff; color: #000; }

        footer { border-top: 1px solid var(--bg-glass-border); background: #000; padding: 2rem 0; margin-top: auto; }
    </style>
</head>
<body>

    <!-- Navegación -->
    <!-- Agregado navbar-dark para compatibilidad extra -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="mainNav">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
                <img src="https://github.com/BrandonSepulveda/BrandonSepulveda.github.io/blob/main/logo/Logo-30.png?raw=true" alt="Logo" width="30">
                <span>Brandon Sepulveda</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto gap-1">
                    <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="herramientas.html">Herramientas</a></li>
                    <li class="nav-item"><a class="nav-link active" href="#">Removedor AI</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <main class="section" style="padding-top: 120px; padding-bottom: 80px;">
        <div class="container">
            
            <!-- Header -->
            <div class="text-center mb-5" data-aos="fade-down">
                <span class="badge rounded-pill border border-light text-light px-3 py-2 mb-3" style="background: rgba(255,255,255,0.05);">Versión 2.5 - HD Quality</span>
                <h1 class="display-4 fw-black mb-2" style="font-weight: 900;">Removedor de <span style="color: var(--kick-color);">Fondos</span></h1>
                <!-- Usamos una clase personalizada inline o !important para asegurar visibilidad -->
                <p class="lead mx-auto text-muted" style="max-width: 600px;">
                    Elimina colores con calidad profesional. Usa el suavizado para perfeccionar los bordes y evitar el efecto dentado.
                </p>
            </div>

            <div class="glass-panel p-4 p-md-5" data-aos="fade-up">
                <div class="row g-5">
                    
                    <!-- Columna Izquierda: Controles -->
                    <div class="col-lg-4">
                        <!-- Paso 1: Upload -->
                        <div class="upload-area mb-4" id="uploadArea">
                            <input type="file" id="fileInput" accept="image/*" class="d-none">
                            <div class="upload-icon-wrapper">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h5 class="fw-bold text-white">Sube tu Imagen</h5>
                            <p class="small text-muted mb-0">Arrastra o haz clic aquí</p>
                        </div>

                        <!-- Paso 2: Ajustes (Oculto inicialmente) -->
                        <div id="controlsPanel" class="d-none opacity-0" style="transition: opacity 0.5s;">
                            
                            <!-- Selector de Color -->
                            <div class="control-group">
                                <label class="control-label"><i class="fas fa-eye-dropper me-2"></i> Color a Eliminar</label>
                                <div class="d-flex flex-column gap-2">
                                    <div class="d-flex align-items-center gap-3 bg-black bg-opacity-25 p-2 rounded-3">
                                        <input type="color" id="colorPicker" value="#ffffff" title="Clic para abrir paleta">
                                        <div class="text-muted small lh-1">
                                            <div>Hexadecimal:</div>
                                            <div id="hexValueDisplay" class="font-monospace text-white">#FFFFFF</div>
                                        </div>
                                    </div>
                                    <button id="pickFromImageBtn" class="btn btn-secondary-custom w-100 d-flex align-items-center justify-content-center gap-2">
                                        <i class="fas fa-crosshairs"></i>
                                        <span id="pickBtnText" style="font-weight: 900;">Seleccionar desde Imagen</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Tolerancia -->
                            <div class="control-group">
                                <div class="d-flex justify-content-between mb-2">
                                    <label class="control-label mb-0"><i class="fas fa-sliders-h me-2"></i> Tolerancia</label>
                                    <span class="badge bg-light text-dark" id="toleranceValue">30</span>
                                </div>
                                <input type="range" id="toleranceSlider" min="0" max="200" value="30">
                                <div class="d-flex justify-content-between text-muted small mt-2">
                                    <span>Preciso</span>
                                    <span>Agresivo</span>
                                </div>
                            </div>

                            <!-- MEJORA: Suavizado (Smoothness) -->
                            <div class="control-group">
                                <div class="d-flex justify-content-between mb-2">
                                    <label class="control-label mb-0"><i class="fas fa-feather-alt me-2"></i> Suavizado de Bordes</label>
                                    <span class="badge bg-light text-dark" id="smoothnessValue">20</span>
                                </div>
                                <input type="range" id="smoothnessSlider" min="0" max="100" value="20">
                                <div class="d-flex justify-content-between text-muted small mt-2">
                                    <span>Duro</span>
                                    <span>Suave</span>
                                </div>
                            </div>

                            <!-- Botones de Acción -->
                            <div class="d-grid gap-3 mt-4">
                                <button id="processButton" class="btn btn-kick">
                                    <i class="fas fa-magic me-2"></i> Procesar Ahora
                                </button>
                                <button id="resetButton" class="btn btn-outline-light btn-sm rounded-pill" style="border-color: rgba(255,255,255,0.1);">
                                    <i class="fas fa-undo me-2"></i> Empezar de nuevo
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Columna Derecha: Visualización -->
                    <div class="col-lg-8">
                        <div id="welcomeMessage" class="h-100 d-flex flex-column align-items-center justify-content-center text-center p-5 border rounded-4 border-dashed border-secondary opacity-50">
                            <i class="far fa-image fa-5x mb-4 text-muted"></i>
                            <h4 class="text-white">Vista Previa</h4>
                            <p class="text-muted">Sube una imagen para comenzar a editar</p>
                        </div>

                        <div id="previewArea" class="d-none">
                            <!-- Tabs de navegación visual -->
                            <ul class="nav nav-pills mb-3 gap-2" id="pills-tab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active rounded-pill px-4" id="pills-result-tab" data-bs-toggle="pill" data-bs-target="#pills-result" type="button" role="tab">Resultado</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link rounded-pill px-4" id="pills-original-tab" data-bs-toggle="pill" data-bs-target="#pills-original" type="button" role="tab">Original</button>
                                </li>
                            </ul>

                            <div class="tab-content" id="pills-tabContent">
                                <!-- Resultado Panel -->
                                <div class="tab-pane fade show active position-relative" id="pills-result" role="tabpanel">
                                    <div class="canvas-wrapper">
                                        <canvas id="transparentCanvas"></canvas>
                                        <!-- Botón Comparar (visible solo cuando hay resultado) -->
                                        <div id="compareOverlay" class="compare-btn d-none">
                                            <i class="fas fa-eye"></i> Mantén para ver original
                                        </div>
                                        <!-- Loading Overlay -->
                                        <div id="loadingIndicator" class="loading-overlay">
                                            <div class="d-flex flex-column align-items-center">
                                                <div class="spinner-custom mb-3"></div>
                                                <span class="fw-bold">Procesando píxeles...</span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Área de Descarga -->
                                    <div id="downloadContainer" class="mt-4 text-center d-none fade-in">
                                        <p class="text-success small fw-bold mb-2"><i class="fas fa-check-circle me-1"></i> Imagen lista en alta resolución</p>
                                        <button id="downloadButton" class="btn btn-kick w-100 py-3">
                                            <i class="fas fa-download me-2"></i> Descargar PNG (HD)
                                        </button>
                                    </div>
                                </div>

                                <!-- Original Panel (Para selección de color) -->
                                <div class="tab-pane fade" id="pills-original" role="tabpanel">
                                    <div class="canvas-wrapper">
                                        <canvas id="originalCanvas"></canvas>
                                    </div>
                                    <p class="text-center small text-muted mt-2">
                                        <i class="fas fa-info-circle"></i> Haz clic en la imagen para seleccionar el color a borrar
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container text-center">
            <p class="text-muted mb-0 small">Diseñado con <span style="color: var(--kick-color);">❤</span> por Jhon Brandon Sepulveda Valdes &copy; 2025</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Inicializar AOS
            AOS.init({ duration: 800, once: true, offset: 30 });

            // Navbar Scroll Effect
            const mainNav = document.getElementById('mainNav');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 20) mainNav.classList.add('navbar-scrolled');
                else mainNav.classList.remove('navbar-scrolled');
            });

            // --- VARIABLES GLOBALES ---
            let originalImage = null;
            let isPickingColor = false;
            // Canvas en memoria para procesamiento HD
            const highResCanvas = document.createElement('canvas');
            const highResCtx = highResCanvas.getContext('2d', { willReadFrequently: true });
            
            // Elementos DOM
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const controlsPanel = document.getElementById('controlsPanel');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const previewArea = document.getElementById('previewArea');
            
            // Controles
            const colorPicker = document.getElementById('colorPicker');
            const hexValueDisplay = document.getElementById('hexValueDisplay');
            const pickFromImageBtn = document.getElementById('pickFromImageBtn');
            const pickBtnText = document.getElementById('pickBtnText');
            
            // Sliders
            const toleranceSlider = document.getElementById('toleranceSlider');
            const toleranceValue = document.getElementById('toleranceValue');
            const smoothnessSlider = document.getElementById('smoothnessSlider');
            const smoothnessValue = document.getElementById('smoothnessValue');

            const processButton = document.getElementById('processButton');
            const downloadButton = document.getElementById('downloadButton');
            const downloadContainer = document.getElementById('downloadContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resetButton = document.getElementById('resetButton');
            const compareOverlay = document.getElementById('compareOverlay');

            // Canvas de visualización
            const originalCanvas = document.getElementById('originalCanvas');
            const transparentCanvas = document.getElementById('transparentCanvas');
            const originalCtx = originalCanvas.getContext('2d', { willReadFrequently: true });
            const transparentCtx = transparentCanvas.getContext('2d');

            // --- FUNCIONES ---

            // Cargar Imagen
            const loadImage = (file) => {
                if (!file || !file.type.match('image.*')) return;

                const reader = new FileReader();
                reader.onload = e => {
                    originalImage = new Image();
                    originalImage.onload = () => {
                        // Mostrar UI
                        welcomeMessage.classList.add('d-none');
                        previewArea.classList.remove('d-none');
                        controlsPanel.classList.remove('d-none');
                        setTimeout(() => controlsPanel.classList.remove('opacity-0'), 50);
                        downloadContainer.classList.add('d-none');

                        // Ajustar tamaño del canvas al contenedor visual
                        // CORRECCIÓN CRÍTICA: Usamos el ancho de transparentCanvas porque es el que está visible en la pestaña activa
                        // originalCanvas está en una pestaña oculta (display:none), por lo que su ancho era 0
                        const containerWidth = transparentCanvas.parentElement.clientWidth;
                        
                        const scale = Math.min(1, containerWidth / originalImage.width);
                        const displayWidth = originalImage.width * scale;
                        const displayHeight = originalImage.height * scale;

                        [originalCanvas, transparentCanvas].forEach(cvs => {
                            cvs.width = displayWidth;
                            cvs.height = displayHeight;
                        });

                        // Dibujar imagen original
                        originalCtx.drawImage(originalImage, 0, 0, displayWidth, displayHeight);
                        // Copiar al transparente como estado inicial
                        transparentCtx.drawImage(originalImage, 0, 0, displayWidth, displayHeight);
                        
                        // Scroll automático suave hacia los controles
                        controlsPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    };
                    originalImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            };

            // Procesar Imagen (Algoritmo de eliminación de fondo MEJORADO)
            const processImage = () => {
                if (!originalImage) return;

                // UI Feedback
                loadingIndicator.classList.add('active');
                downloadContainer.classList.add('d-none');
                processButton.disabled = true;

                // Usamos setTimeout para permitir que el navegador renderice el loading state
                setTimeout(() => {
                    // Configurar canvas HD
                    highResCanvas.width = originalImage.width;
                    highResCanvas.height = originalImage.height;
                    highResCtx.drawImage(originalImage, 0, 0);

                    const imageData = highResCtx.getImageData(0, 0, highResCanvas.width, highResCanvas.height);
                    const data = imageData.data;
                    const targetColor = hexToRgb(colorPicker.value);
                    const tolerance = parseInt(toleranceSlider.value);
                    const smoothness = parseInt(smoothnessSlider.value); // Valor de suavizado

                    // Loop de píxeles
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i], g = data[i + 1], b = data[i + 2];
                        
                        // Distancia Euclidiana simple para comparar colores
                        const diff = Math.sqrt(
                            Math.pow(r - targetColor.r, 2) +
                            Math.pow(g - targetColor.g, 2) +
                            Math.pow(b - targetColor.b, 2)
                        );

                        // Lógica de Suavizado (Feathering)
                        if (diff <= tolerance) {
                            // Dentro de la tolerancia estricta: Transparente total
                            data[i + 3] = 0; 
                        } else if (diff < tolerance + smoothness) {
                            // En la zona de transición: Transparencia gradual
                            // Cuanto más cerca del límite, más transparente
                            // Calculamos alpha de 0 a 255
                            const factor = (diff - tolerance) / smoothness; 
                            data[i + 3] = factor * 255;
                        }
                        // Si es mayor que tolerance + smoothness, se mantiene opaco (255)
                    }

                    // Poner datos procesados en canvas HD
                    highResCtx.putImageData(imageData, 0, 0);

                    // Actualizar vista previa (escalada)
                    transparentCtx.clearRect(0, 0, transparentCanvas.width, transparentCanvas.height);
                    transparentCtx.drawImage(highResCanvas, 0, 0, transparentCanvas.width, transparentCanvas.height);

                    // Finalizar UI
                    loadingIndicator.classList.remove('active');
                    downloadContainer.classList.remove('d-none');
                    downloadContainer.classList.add('fade-in');
                    compareOverlay.classList.remove('d-none');
                    processButton.disabled = false;
                    
                    // Activar tab de resultado si no está activo
                    document.getElementById('pills-result-tab').click();

                }, 100); // Pequeño delay para UX
            };

            // Descargar
            const downloadImage = () => {
                const link = document.createElement('a');
                link.download = `BS_Removedor_${Date.now()}.png`;
                link.href = highResCanvas.toDataURL('image/png');
                link.click();
            };

            // Selector de Color (Modo Gotero)
            const toggleColorPicking = (enable) => {
                isPickingColor = enable;
                originalCanvas.style.cursor = enable ? 'crosshair' : 'default';
                
                if (enable) {
                    pickFromImageBtn.classList.add('active-mode');
                    pickBtnText.textContent = "Cancelar Gotero";
                    // Cambiar automáticamente al tab original
                    document.getElementById('pills-original-tab').click();
                } else {
                    pickFromImageBtn.classList.remove('active-mode');
                    pickBtnText.textContent = "Seleccionar desde Imagen";
                }
            };

            // Utiles Color
            const hexToRgb = (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
            };
            const rgbToHex = (r, g, b) => "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();

            // --- EVENT LISTENERS ---

            // Upload
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', e => loadImage(e.target.files[0]));
            
            // Drag & Drop
            uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', e => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                loadImage(e.dataTransfer.files[0]);
            });

            // Sliders & Botones
            toleranceSlider.addEventListener('input', () => toleranceValue.textContent = toleranceSlider.value);
            smoothnessSlider.addEventListener('input', () => smoothnessValue.textContent = smoothnessSlider.value); // Nuevo listener
            
            colorPicker.addEventListener('input', (e) => hexValueDisplay.textContent = e.target.value.toUpperCase());
            processButton.addEventListener('click', processImage);
            downloadButton.addEventListener('click', downloadImage);
            
            // Reset
            resetButton.addEventListener('click', () => {
                location.reload(); // Forma más simple de resetear todo limpio
            });

            // Lógica Gotero
            pickFromImageBtn.addEventListener('click', () => toggleColorPicking(!isPickingColor));
            
            originalCanvas.addEventListener('click', e => {
                if (!isPickingColor) return;
                
                const rect = originalCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Calcular coordenadas reales en la imagen visualizada
                const scaleX = originalCanvas.width / rect.width;
                const scaleY = originalCanvas.height / rect.height;

                const pixelData = originalCtx.getImageData(x * scaleX, y * scaleY, 1, 1).data;
                const hexColor = rgbToHex(pixelData[0], pixelData[1], pixelData[2]);
                
                colorPicker.value = hexColor;
                hexValueDisplay.textContent = hexColor;
                
                toggleColorPicking(false);
                
                // Efecto visual al seleccionar
                pickFromImageBtn.innerHTML = `<i class="fas fa-check"></i> <span style="font-weight:900;">Color Seleccionado</span>`;
                setTimeout(() => {
                    pickFromImageBtn.innerHTML = `<i class="fas fa-crosshairs"></i> <span id="pickBtnText" style="font-weight: 900;">Seleccionar desde Imagen</span>`;
                }, 1500);
            });

            // Función Comparar (Press to view original)
            const showOriginalPreview = () => {
                transparentCtx.clearRect(0, 0, transparentCanvas.width, transparentCanvas.height);
                transparentCtx.drawImage(originalImage, 0, 0, transparentCanvas.width, transparentCanvas.height);
                compareOverlay.innerHTML = '<i class="fas fa-eye-slash"></i> Soltar para ver resultado';
            };
            
            const returnToResult = () => {
                transparentCtx.clearRect(0, 0, transparentCanvas.width, transparentCanvas.height);
                transparentCtx.drawImage(highResCanvas, 0, 0, transparentCanvas.width, transparentCanvas.height);
                compareOverlay.innerHTML = '<i class="fas fa-eye"></i> Mantén para ver original';
            };

            compareOverlay.addEventListener('mousedown', showOriginalPreview);
            compareOverlay.addEventListener('mouseup', returnToResult);
            compareOverlay.addEventListener('mouseleave', returnToResult);
            // Soporte táctil
            compareOverlay.addEventListener('touchstart', (e) => { e.preventDefault(); showOriginalPreview(); });
            compareOverlay.addEventListener('touchend', (e) => { e.preventDefault(); returnToResult(); });

        });
    </script>
</body>
</html>
